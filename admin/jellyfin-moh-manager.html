<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jellyfin Music On Hold Manager - FlexPBX</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            margin-bottom: 20px;
        }

        .nav-tabs .nav-link {
            color: #667eea;
            border: none;
            border-bottom: 3px solid transparent;
        }

        .nav-tabs .nav-link.active {
            color: #764ba2;
            border-bottom-color: #764ba2;
            background: transparent;
        }

        .stream-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .stream-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-active { background: #4ade80; }
        .status-inactive { background: #ef4444; }
        .status-testing { background: #fbbf24; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .playlist-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .playlist-pls { background: #e3f2fd; color: #1976d2; }
        .playlist-m3u { background: #f3e5f5; color: #7b1fa2; }
        .playlist-jellyfin { background: #e8f5e9; color: #388e3c; }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1><i class="fas fa-music me-2"></i>Jellyfin Music On Hold Manager</h1>
                    <p class="text-muted mb-0">Stream music from Jellyfin or playlists (.pls, .m3u) to Asterisk MOH</p>
                    <p style="color: #764ba2; font-weight: 600; margin-top: 10px; font-style: italic;">
                        A system you can help build to be the best it can be. Accessible by default.
                    </p>
                </div>
                <a href="/admin/" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-4" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-jellyfin">
                        <i class="fas fa-server me-2"></i>Jellyfin Libraries
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-playlists">
                        <i class="fas fa-list me-2"></i>Playlist Files
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-moh">
                        <i class="fas fa-phone me-2"></i>MOH Classes
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-config">
                        <i class="fas fa-cog me-2"></i>Configuration
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Jellyfin Libraries Tab -->
                <div class="tab-pane fade show active" id="tab-jellyfin">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Browse Jellyfin music libraries and create MOH classes from playlists or folders
                    </div>

                    <button class="btn btn-primary mb-3" onclick="loadJellyfinLibraries()">
                        <i class="fas fa-sync me-2"></i>Refresh Libraries
                    </button>

                    <div id="jellyfin-libraries">
                        <div class="text-center py-5">
                            <p class="text-muted">Click "Refresh Libraries" to load Jellyfin music</p>
                        </div>
                    </div>
                </div>

                <!-- Playlist Files Tab -->
                <div class="tab-pane fade" id="tab-playlists">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Import .pls and .m3u playlist files from your server
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Playlist File Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="playlist-path"
                                   placeholder="/home/dom/apps/media/streams/soulfood.pls">
                            <button class="btn btn-primary" onclick="importPlaylist()">
                                <i class="fas fa-upload me-2"></i>Import
                            </button>
                        </div>
                        <small class="text-muted">Example paths:</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="fillPath('/home/dom/apps/media/streams/soulfood.pls')">
                                SoulFood Radio (.pls)
                            </button>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="fillPath('/home/dom/apps/media/streams/chrismix.pls')">
                                ChrisMix Radio (.pls)
                            </button>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="fillPath('/home/dom/apps/media/playlists/index.m3u')">
                                Index Playlist (.m3u)
                            </button>
                        </div>
                    </div>

                    <div id="playlist-results"></div>
                </div>

                <!-- MOH Classes Tab -->
                <div class="tab-pane fade" id="tab-moh">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Manage Asterisk Music On Hold classes for call queues and parking
                    </div>

                    <button class="btn btn-primary mb-3" onclick="loadMohClasses()">
                        <i class="fas fa-sync me-2"></i>Refresh MOH Classes
                    </button>

                    <div id="moh-classes">
                        <div class="text-center py-5">
                            <p class="text-muted">Click "Refresh MOH Classes" to load current classes</p>
                        </div>
                    </div>

                    <!-- Add MOH Class Form -->
                    <div class="card mt-4">
                        <div class="card-body">
                            <h5 class="card-title">Add New MOH Class</h5>
                            <form id="add-moh-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Class Name *</label>
                                        <input type="text" class="form-control" id="moh-name" required
                                               placeholder="soulfood-radio">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Type *</label>
                                        <select class="form-select" id="moh-type" required>
                                            <option value="custom">Streaming (Jellyfin/.pls/.m3u)</option>
                                            <option value="files">Local Files</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Stream URL or Directory *</label>
                                    <input type="text" class="form-control" id="moh-source" required
                                           placeholder="http://s38.myradiostream.com:15874">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <input type="text" class="form-control" id="moh-description"
                                           placeholder="SoulFood Radio - Live Stream">
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus me-2"></i>Add MOH Class
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Configuration Tab -->
                <div class="tab-pane fade" id="tab-config">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Configure Jellyfin connection settings
                    </div>

                    <form id="config-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Jellyfin Host</label>
                                <input type="text" class="form-control" id="config-host" value="localhost">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Jellyfin Port</label>
                                <input type="text" class="form-control" id="config-port" value="8096">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Jellyfin API Key</label>
                            <input type="password" class="form-control" id="config-api-key"
                                   placeholder="Enter Jellyfin API key">
                            <small class="text-muted">Get API key from Jellyfin Dashboard → API Keys</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Jellyfin User ID (optional)</label>
                            <input type="text" class="form-control" id="config-user-id"
                                   placeholder="User ID for library access">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save Configuration
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="testJellyfinConnection()">
                            <i class="fas fa-vial me-2"></i>Test Connection
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api/jellyfin-moh.php';

        // Load Jellyfin libraries
        async function loadJellyfinLibraries() {
            const container = document.getElementById('jellyfin-libraries');
            container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2">Loading libraries...</p></div>';

            try {
                const response = await fetch(`${API_BASE}?path=list_libraries`);
                const data = await response.json();

                if (data.success) {
                    renderLibraries(data.libraries);
                } else {
                    container.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">Error loading libraries: ${error.message}</div>`;
            }
        }

        function renderLibraries(libraries) {
            const container = document.getElementById('jellyfin-libraries');

            if (libraries.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No music libraries found</div>';
                return;
            }

            let html = '';
            libraries.forEach(lib => {
                html += `
                    <div class="stream-item">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-1"><i class="fas fa-folder me-2"></i>${lib.Name}</h5>
                                <small class="text-muted">ID: ${lib.Id}</small>
                            </div>
                            <div class="col-md-6 text-end">
                                <span class="playlist-badge playlist-jellyfin">Jellyfin</span>
                                <button class="btn btn-sm btn-primary ms-2" onclick="createMohFromJellyfin('${lib.Id}', '${lib.Name}')">
                                    <i class="fas fa-plus me-1"></i>Create MOH
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Import playlist file
        async function importPlaylist() {
            const path = document.getElementById('playlist-path').value;
            if (!path) {
                alert('Please enter a playlist file path');
                return;
            }

            const resultsDiv = document.getElementById('playlist-results');
            resultsDiv.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>';

            try {
                const formData = new FormData();
                formData.append('file_path', path);

                const response = await fetch(`${API_BASE}?path=import_playlist`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i>Playlist Imported</h5>
                            <p><strong>Stream URL:</strong> ${data.stream_url}</p>
                            <p><strong>File Type:</strong> .${data.file_type}</p>
                            <button class="btn btn-primary mt-2" onclick="document.getElementById('moh-source').value='${data.stream_url}'; document.querySelector('[data-bs-target=\\\"#tab-moh\\\"]').click();">
                                Create MOH Class
                            </button>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        // Load MOH classes
        async function loadMohClasses() {
            const container = document.getElementById('moh-classes');
            container.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>';

            try {
                const response = await fetch(`${API_BASE}?path=list_moh_classes`);
                const data = await response.json();

                if (data.success) {
                    renderMohClasses(data.classes, data.raw_output);
                } else {
                    container.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        function renderMohClasses(classes, rawOutput) {
            const container = document.getElementById('moh-classes');

            let html = '<div class="list-group">';
            classes.forEach(cls => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">${cls}</h5>
                                <span class="status-indicator status-active"></span>
                                <small class="text-muted">Active</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            html += `<div class="card mt-3"><div class="card-body"><h6>Asterisk Output:</h6><pre class="mb-0">${rawOutput}</pre></div></div>`;

            container.innerHTML = html;
        }

        // Add MOH class
        document.getElementById('add-moh-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('moh-name').value;
            const type = document.getElementById('moh-type').value;
            const source = document.getElementById('moh-source').value;
            const description = document.getElementById('moh-description').value;

            const formData = new FormData();
            formData.append('name', name);
            formData.append('type', type);
            formData.append('source', source);
            formData.append('description', description);

            try {
                const response = await fetch(`${API_BASE}?path=add_moh_class`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert('MOH class added successfully!');
                    document.getElementById('add-moh-form').reset();
                    loadMohClasses();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Save configuration
        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const config = {
                jellyfin_host: document.getElementById('config-host').value,
                jellyfin_port: document.getElementById('config-port').value,
                jellyfin_api_key: document.getElementById('config-api-key').value,
                jellyfin_user_id: document.getElementById('config-user-id').value
            };

            try {
                const response = await fetch(`${API_BASE}?path=save_config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                alert(data.message);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Helper functions
        function fillPath(path) {
            document.getElementById('playlist-path').value = path;
        }

        function createMohFromJellyfin(id, name) {
            const cleanName = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
            document.getElementById('moh-name').value = cleanName;
            document.getElementById('moh-source').value = `http://localhost:8096/Audio/${id}/stream`;
            document.querySelector('[data-bs-target="#tab-moh"]').click();
        }

        async function testJellyfinConnection() {
            const host = document.getElementById('config-host').value;
            const port = document.getElementById('config-port').value;

            try {
                const response = await fetch(`http://${host}:${port}/System/Info/Public`);
                if (response.ok) {
                    alert('✅ Jellyfin connection successful!');
                } else {
                    alert('❌ Jellyfin server responded with error: ' + response.status);
                }
            } catch (error) {
                alert('❌ Cannot connect to Jellyfin: ' + error.message);
            }
        }

        // Load configuration on page load
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`${API_BASE}?path=get_config`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('config-host').value = data.config.jellyfin_host || 'localhost';
                    document.getElementById('config-port').value = data.config.jellyfin_port || '8096';
                    document.getElementById('config-api-key').value = data.config.jellyfin_api_key || '';
                    document.getElementById('config-user-id').value = data.config.jellyfin_user_id || '';
                }
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        });
    </script>
</body>
</html>
