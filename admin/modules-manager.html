<!DOCTYPE html>
<html lang="en">
<!--
    FlexPBX Modules Manager
    Created: October 17, 2025
    Features:
    - Install/uninstall modules
    - Update modules
    - Push updates to remote servers
    - Module marketplace/registry
    - Automatic update checking
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexPBX Admin - Modules Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }
        .sidebar a:hover, .sidebar .active {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .stat-card {
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        .stat-card.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stat-card.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        .stat-card.warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff6b6b 100%);
            color: white;
        }
        .stat-card.info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .module-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
            background: white;
        }
        .module-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .module-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        .module-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status-installed {
            background: #d1e7dd;
            color: #0f5132;
        }
        .status-available {
            background: #cfe2ff;
            color: #084298;
        }
        .status-update {
            background: #fff3cd;
            color: #856404;
        }
        .module-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-4">
                <h4 class="text-white mb-4"><i class="fas fa-phone-alt"></i> FlexPBX</h4>
                <nav class="nav flex-column">
                    <a class="nav-link p-3" href="dashboard.html">
                        <i class="fas fa-home me-2"></i> Dashboard
                    </a>
                    <a class="nav-link p-3 active" href="modules-manager.html">
                        <i class="fas fa-cube me-2"></i> Modules Manager
                    </a>
                    <a class="nav-link p-3" href="backup-restore.html">
                        <i class="fas fa-database me-2"></i> Backup & Restore
                    </a>
                    <a class="nav-link p-3" href="call-logs.html">
                        <i class="fas fa-phone me-2"></i> Call Logs
                    </a>
                    <a class="nav-link p-3" href="admin-security.html">
                        <i class="fas fa-shield-alt me-2"></i> Security
                    </a>
                    <a class="nav-link p-3" href="index.html">
                        <i class="fas fa-cog me-2"></i> Settings
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="fas fa-cube text-primary"></i> Modules Manager</h2>
                        <p class="text-muted">Install, update, and manage FlexPBX modules</p>
                    </div>
                    <div>
                        <button class="btn btn-primary me-2" onclick="checkForUpdates()">
                            <i class="fas fa-sync-alt me-2"></i>Check Updates
                        </button>
                        <button class="btn btn-success" onclick="showPushUpdateModal()">
                            <i class="fas fa-cloud-upload-alt me-2"></i>Push Update
                        </button>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card primary">
                            <div class="stat-label">Total Modules</div>
                            <p class="stat-value" id="totalModules">0</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card success">
                            <div class="stat-label">Installed</div>
                            <p class="stat-value" id="installedModules">0</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card info">
                            <div class="stat-label">Available</div>
                            <p class="stat-value" id="availableModules">0</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card warning">
                            <div class="stat-label">Updates</div>
                            <p class="stat-value" id="updatesAvailable">0</p>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs mb-4" id="moduleTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-tab="all" href="#" onclick="switchTab(event, 'all')">
                            All Modules
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-tab="installed" href="#" onclick="switchTab(event, 'installed')">
                            Installed
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-tab="available" href="#" onclick="switchTab(event, 'available')">
                            Available
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-tab="updates" href="#" onclick="switchTab(event, 'updates')">
                            <span class="badge bg-warning text-dark" id="updatesBadge">0</span> Updates
                        </a>
                    </li>
                </ul>

                <!-- Filters -->
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchModules" placeholder="Search modules..." onkeyup="filterModules()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="categoryFilter" onchange="filterModules()">
                                <option value="">All Categories</option>
                                <option value="administration">Administration</option>
                                <option value="reporting">Reporting</option>
                                <option value="telephony">Telephony</option>
                                <option value="integration">Integration</option>
                                <option value="communication">Communication</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter" onchange="filterModules()">
                                <option value="">All Status</option>
                                <option value="stable">Stable</option>
                                <option value="beta">Beta</option>
                                <option value="alpha">Alpha</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Modules List -->
                <div id="modulesList" class="row">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Tab Content Areas -->
                <div id="allTab" class="tab-content active"></div>
                <div id="installedTab" class="tab-content"></div>
                <div id="availableTab" class="tab-content"></div>
                <div id="updatesTab" class="tab-content"></div>
            </div>
        </div>
    </div>

    <!-- Push Update Modal -->
    <div class="modal fade" id="pushUpdateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cloud-upload-alt me-2"></i>Push Update to Remote Server</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>Module:</strong></label>
                        <select class="form-select" id="pushModule">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Target Server:</strong></label>
                        <input type="text" class="form-control" id="pushHost" placeholder="https://server.example.com">
                        <small class="text-muted">Full URL including protocol</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>API Key:</strong></label>
                        <input type="password" class="form-control" id="pushApiKey" placeholder="API key for authentication">
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>This will push the selected module to the remote server and install it automatically.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="pushUpdate()">
                        <i class="fas fa-cloud-upload-alt me-2"></i>Push Update
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Module Details Modal -->
    <div class="modal fade" id="moduleDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="moduleDetailsTitle">Module Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="moduleDetailsBody">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allModules = [];
        let pushUpdateModal = null;
        let moduleDetailsModal = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            pushUpdateModal = new bootstrap.Modal(document.getElementById('pushUpdateModal'));
            moduleDetailsModal = new bootstrap.Modal(document.getElementById('moduleDetailsModal'));
            loadModules();
        });

        // Load all modules
        async function loadModules() {
            try {
                const response = await fetch('/api/modules.php?path=list');
                const data = await response.json();

                if (data.success) {
                    allModules = data.data.modules;
                    updateStatistics(data.data);
                    displayModules(allModules);
                } else {
                    showError('Failed to load modules: ' + data.message);
                }
            } catch (error) {
                showError('Error loading modules: ' + error.message);
            }
        }

        // Update statistics
        function updateStatistics(data) {
            document.getElementById('totalModules').textContent = data.total || 0;
            document.getElementById('installedModules').textContent = data.installed_count || 0;
            document.getElementById('availableModules').textContent = data.available_count || 0;

            const updates = allModules.filter(m => m.update_available).length;
            document.getElementById('updatesAvailable').textContent = updates;
            document.getElementById('updatesBadge').textContent = updates;
        }

        // Display modules
        function displayModules(modules) {
            const container = document.getElementById('modulesList');

            if (modules.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted">No modules found</div>';
                return;
            }

            container.innerHTML = modules.map(module => `
                <div class="col-md-6 col-lg-4 module-item" data-category="${module.category}" data-status="${module.status}">
                    <div class="module-card">
                        <div class="module-icon">${module.icon || '📦'}</div>
                        <h5>
                            ${module.display_name}
                            <span class="module-status status-${module.status}">${module.status === 'installed' ? 'Installed' : 'Available'}</span>
                            ${module.update_available ? '<span class="module-status status-update">Update Available</span>' : ''}
                        </h5>
                        <p class="text-muted">${module.description}</p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small><strong>Version:</strong> ${module.version}</small>
                            <small><strong>Size:</strong> ${module.size}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small><strong>Category:</strong> ${module.category}</small>
                            <small><strong>Updated:</strong> ${module.last_updated}</small>
                        </div>
                        <div class="module-actions">
                            ${module.status === 'installed' ? `
                                <button class="btn btn-sm btn-danger" onclick="uninstallModule('${module.name}')">
                                    <i class="fas fa-trash"></i> Uninstall
                                </button>
                                ${module.update_available ? `
                                    <button class="btn btn-sm btn-warning" onclick="updateModule('${module.name}')">
                                        <i class="fas fa-sync-alt"></i> Update
                                    </button>
                                ` : ''}
                            ` : `
                                <button class="btn btn-sm btn-primary" onclick="installModule('${module.name}')">
                                    <i class="fas fa-download"></i> Install
                                </button>
                            `}
                            <button class="btn btn-sm btn-secondary" onclick="showModuleDetails('${module.name}')">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Switch tabs
        function switchTab(event, tab) {
            event.preventDefault();

            // Update active tab
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');

            // Filter and display modules
            let filtered = allModules;

            switch(tab) {
                case 'installed':
                    filtered = allModules.filter(m => m.status === 'installed');
                    break;
                case 'available':
                    filtered = allModules.filter(m => m.status !== 'installed');
                    break;
                case 'updates':
                    filtered = allModules.filter(m => m.update_available);
                    break;
            }

            displayModules(filtered);
        }

        // Filter modules
        function filterModules() {
            const search = document.getElementById('searchModules').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const status = document.getElementById('statusFilter').value;

            const filtered = allModules.filter(module => {
                const matchSearch = module.display_name.toLowerCase().includes(search) ||
                                  module.description.toLowerCase().includes(search);
                const matchCategory = !category || module.category === category;
                const matchStatus = !status || module.status === status;

                return matchSearch && matchCategory && matchStatus;
            });

            displayModules(filtered);
        }

        // Install module
        async function installModule(moduleName) {
            if (!confirm(`Install module "${moduleName}"?`)) return;

            try {
                showProgress('Installing module...');

                const response = await fetch('/api/modules.php?path=install', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ module: moduleName })
                });

                const data = await response.json();
                hideProgress();

                if (data.success) {
                    showSuccess('Module installed successfully!');
                    loadModules();
                } else {
                    showError('Installation failed: ' + data.message);
                }
            } catch (error) {
                hideProgress();
                showError('Error: ' + error.message);
            }
        }

        // Uninstall module
        async function uninstallModule(moduleName) {
            if (!confirm(`Uninstall module "${moduleName}"? This will remove all module files and data.`)) return;

            try {
                showProgress('Uninstalling module...');

                const response = await fetch('/api/modules.php?path=uninstall', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ module: moduleName })
                });

                const data = await response.json();
                hideProgress();

                if (data.success) {
                    showSuccess('Module uninstalled successfully!');
                    loadModules();
                } else {
                    showError('Uninstall failed: ' + data.message);
                }
            } catch (error) {
                hideProgress();
                showError('Error: ' + error.message);
            }
        }

        // Update module
        async function updateModule(moduleName) {
            if (!confirm(`Update module "${moduleName}" to the latest version?`)) return;

            try {
                showProgress('Updating module...');

                const response = await fetch('/api/modules.php?path=update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ module: moduleName })
                });

                const data = await response.json();
                hideProgress();

                if (data.success) {
                    showSuccess('Module updated successfully!');
                    loadModules();
                } else {
                    showError('Update failed: ' + data.message);
                }
            } catch (error) {
                hideProgress();
                showError('Error: ' + error.message);
            }
        }

        // Check for updates
        async function checkForUpdates() {
            try {
                showProgress('Checking for updates...');

                const response = await fetch('/api/modules.php?path=check_updates');
                const data = await response.json();
                hideProgress();

                if (data.success) {
                    const count = data.data.count;
                    if (count > 0) {
                        showSuccess(`${count} update(s) available!`);
                        loadModules();
                    } else {
                        showSuccess('All modules are up to date!');
                    }
                } else {
                    showError('Check failed: ' + data.message);
                }
            } catch (error) {
                hideProgress();
                showError('Error: ' + error.message);
            }
        }

        // Show push update modal
        function showPushUpdateModal() {
            // Populate module select
            const select = document.getElementById('pushModule');
            const installed = allModules.filter(m => m.status === 'installed');

            select.innerHTML = installed.map(m =>
                `<option value="${m.name}">${m.display_name} (v${m.version})</option>`
            ).join('');

            pushUpdateModal.show();
        }

        // Push update
        async function pushUpdate() {
            const module = document.getElementById('pushModule').value;
            const host = document.getElementById('pushHost').value;
            const apiKey = document.getElementById('pushApiKey').value;

            if (!module || !host) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                pushUpdateModal.hide();
                showProgress('Pushing update...');

                const response = await fetch('/api/modules.php?path=push_update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ module, host, api_key: apiKey })
                });

                const data = await response.json();
                hideProgress();

                if (data.success) {
                    showSuccess('Update pushed successfully!');
                } else {
                    showError('Push failed: ' + data.message);
                }
            } catch (error) {
                hideProgress();
                showError('Error: ' + error.message);
            }
        }

        // Show module details
        function showModuleDetails(moduleName) {
            const module = allModules.find(m => m.name === moduleName);
            if (!module) return;

            document.getElementById('moduleDetailsTitle').textContent = module.display_name;
            document.getElementById('moduleDetailsBody').innerHTML = `
                <div class="row">
                    <div class="col-md-12 text-center mb-3">
                        <div style="font-size: 4rem;">${module.icon || '📦'}</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6"><strong>Name:</strong></div>
                    <div class="col-md-6">${module.display_name}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6"><strong>Version:</strong></div>
                    <div class="col-md-6">${module.version}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6"><strong>Category:</strong></div>
                    <div class="col-md-6">${module.category}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6"><strong>Author:</strong></div>
                    <div class="col-md-6">${module.author}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6"><strong>Status:</strong></div>
                    <div class="col-md-6"><span class="module-status status-${module.status}">${module.status}</span></div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6"><strong>Size:</strong></div>
                    <div class="col-md-6">${module.size}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6"><strong>Last Updated:</strong></div>
                    <div class="col-md-6">${module.last_updated}</div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <strong>Description:</strong>
                        <p class="mt-2">${module.description}</p>
                    </div>
                </div>
                ${module.homepage ? `
                <div class="row mt-2">
                    <div class="col-md-12">
                        <a href="${module.homepage}" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-external-link-alt me-2"></i>Visit Homepage
                        </a>
                    </div>
                </div>
                ` : ''}
            `;

            moduleDetailsModal.show();
        }

        // Helper functions
        function showProgress(message) {
            // TODO: Implement progress modal
            console.log(message);
        }

        function hideProgress() {
            // TODO: Hide progress modal
        }

        function showSuccess(message) {
            alert(message); // TODO: Replace with toast
        }

        function showError(message) {
            alert('Error: ' + message); // TODO: Replace with toast
        }
    </script>
</body>
</html>
