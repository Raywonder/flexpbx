<!DOCTYPE html>
<html>
<head>
    <title>FlexPBX - Inbound Call Routing</title>
    <style>
        body {
            font-family: system-ui;
            background: #1e1e1e;
            color: white;
            padding: 20px;
            margin: 0;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        .route-card {
            background: #333;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }
        .route-card.active {
            border-left-color: #4ade80;
        }
        label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 5px;
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #005999; }
        button.danger { background: #dc2626; }
        button.danger:hover { background: #991b1b; }
        button.success { background: #16a34a; }
        button.success:hover { background: #15803d; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
        .warning { color: #fbbf24; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .route-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .route-option {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid #555;
            text-align: center;
            transition: all 0.3s;
        }
        .route-option:hover {
            border-color: #007acc;
            background: #3d3d3d;
        }
        .route-option.selected {
            border-color: #4ade80;
            background: #2d4a2d;
        }
        .route-option .icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .config-panel {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #2d2d2d;
            border-radius: 5px;
        }
        .config-panel.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
        th {
            background: #2d2d2d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìû Inbound Call Routing Configuration</h1>
            <p>Configure where incoming calls from your trunks are routed</p>
        </div>

        <!-- Current Routes -->
        <div class="section">
            <h2>Current Inbound Routes</h2>
            <div id="current-routes">
                <div class="route-card active">
                    <h3>üîµ Callcentric Trunk - Default Route</h3>
                    <p><strong>DID:</strong> [Your Callcentric Number]</p>
                    <p><strong>Current Destination:</strong> <span id="current-dest">IVR (Extension 101)</span></p>
                    <p><strong>Status:</strong> <span class="success">Active</span></p>
                    <button onclick="editRoute('callcentric')">‚úèÔ∏è Edit Route</button>
                    <button onclick="testRoute('callcentric')">üß™ Test Route</button>
                </div>

                <div class="route-card">
                    <h3>üîµ Google Voice - Secondary Route</h3>
                    <p><strong>Number:</strong> (281) 301-5784</p>
                    <p><strong>Current Destination:</strong> <span id="gv-dest">IVR (Extension 101)</span></p>
                    <p><strong>Status:</strong> <span class="success">Active</span></p>
                    <button onclick="editRoute('googlevoice')">‚úèÔ∏è Edit Route</button>
                </div>
            </div>
        </div>

        <!-- Route Configuration -->
        <div class="section" id="route-config" style="display:none;">
            <h2>Configure Inbound Destination</h2>
            <p class="info">Select where incoming calls should be routed:</p>

            <div class="route-options">
                <div class="route-option" onclick="selectRouteType('ivr')">
                    <div class="icon">üìã</div>
                    <strong>IVR Menu</strong>
                    <p>Auto-attendant menu</p>
                </div>

                <div class="route-option" onclick="selectRouteType('queue')">
                    <div class="icon">üìû</div>
                    <strong>Call Queue</strong>
                    <p>Ring group of agents</p>
                </div>

                <div class="route-option" onclick="selectRouteType('extension')">
                    <div class="icon">üë§</div>
                    <strong>Extension</strong>
                    <p>Direct to extension</p>
                </div>

                <div class="route-option" onclick="selectRouteType('voicemail')">
                    <div class="icon">üìß</div>
                    <strong>Voicemail</strong>
                    <p>Leave a message</p>
                </div>

                <div class="route-option" onclick="selectRouteType('announcement')">
                    <div class="icon">üîä</div>
                    <strong>Announcement</strong>
                    <p>Play message & hangup</p>
                </div>

                <div class="route-option" onclick="selectRouteType('custom')">
                    <div class="icon">‚öôÔ∏è</div>
                    <strong>Custom</strong>
                    <p>Advanced routing</p>
                </div>
            </div>

            <!-- IVR Config -->
            <div id="config-ivr" class="config-panel">
                <h3>IVR Menu Configuration</h3>
                <label>Select IVR Menu:</label>
                <select id="ivr-select">
                    <option value="101">Main IVR (Extension 101)</option>
                    <option value="102">After Hours IVR</option>
                    <option value="103">Custom IVR 1</option>
                </select>
                <label>Greeting File:</label>
                <select id="ivr-greeting">
                    <option value="main-greeting.wav">Main Greeting</option>
                    <option value="business-hours.wav">Business Hours</option>
                    <option value="after-hours.wav">After Hours</option>
                </select>
            </div>

            <!-- Queue Config -->
            <div id="config-queue" class="config-panel">
                <h3>Call Queue Configuration</h3>
                <label>Select Queue:</label>
                <select id="queue-select">
                    <option value="sales-queue">Sales Department</option>
                    <option value="tech-support">Technical Support</option>
                    <option value="accessibility-support">Accessibility Support</option>
                    <option value="general">General Queue</option>
                </select>
                <label>Music on Hold:</label>
                <select id="queue-moh">
                    <option value="corporate">Corporate (Upbeat)</option>
                    <option value="ambient">Ambient (Relaxing)</option>
                    <option value="jazz">Jazz</option>
                </select>
                <label>
                    <input type="checkbox" id="queue-announce"> Announce position in queue
                </label>
            </div>

            <!-- Extension Config -->
            <div id="config-extension" class="config-panel">
                <h3>Extension Configuration</h3>
                <label>Select Extension:</label>
                <select id="ext-select">
                    <option value="2001">2001 - Senior Tech Support</option>
                    <option value="2000">2000 - Support Manager</option>
                    <option value="1000">1000 - Sales Manager</option>
                    <option value="1001">1001 - Sales Rep 1</option>
                </select>
                <label>If No Answer:</label>
                <select id="ext-failover">
                    <option value="voicemail">Go to Voicemail</option>
                    <option value="queue">Send to Queue</option>
                    <option value="ivr">Return to IVR</option>
                </select>
                <label>Ring Time (seconds):</label>
                <input type="number" id="ext-ringtime" value="30" min="10" max="60">
            </div>

            <!-- Voicemail Config -->
            <div id="config-voicemail" class="config-panel">
                <h3>Voicemail Configuration</h3>
                <label>Voicemail Box:</label>
                <select id="vm-box">
                    <option value="general">General Mailbox</option>
                    <option value="2001">Extension 2001 Mailbox</option>
                    <option value="sales">Sales Department</option>
                    <option value="support">Support Department</option>
                </select>
                <label>
                    <input type="checkbox" id="vm-email" checked> Email notification
                </label>
                <label>Email Address:</label>
                <input type="email" id="vm-email-addr" placeholder="voicemail@flexpbx.devinecreations.net">
            </div>

            <!-- Announcement Config -->
            <div id="config-announcement" class="config-panel">
                <h3>Announcement Configuration</h3>
                <label>Select Audio File:</label>
                <select id="announce-file">
                    <option value="closed.wav">Business Closed</option>
                    <option value="holiday.wav">Holiday Hours</option>
                    <option value="emergency.wav">Emergency Message</option>
                </select>
                <label>After Announcement:</label>
                <select id="announce-action">
                    <option value="hangup">Hang Up</option>
                    <option value="voicemail">Send to Voicemail</option>
                    <option value="ivr">Go to IVR</option>
                </select>
            </div>

            <!-- Custom Config -->
            <div id="config-custom" class="config-panel">
                <h3>Custom Routing Configuration</h3>
                <label>Time-Based Routing:</label>
                <select id="custom-time">
                    <option value="always">Always</option>
                    <option value="business">Business Hours Only</option>
                    <option value="after">After Hours Only</option>
                    <option value="weekend">Weekends Only</option>
                </select>
                <label>Business Hours Destination:</label>
                <input type="text" id="custom-bh" placeholder="ivr:101 or queue:sales">
                <label>After Hours Destination:</label>
                <input type="text" id="custom-ah" placeholder="voicemail:general">
            </div>

            <div style="margin-top: 20px;">
                <button class="success" onclick="saveRoute()">üíæ Save Route</button>
                <button onclick="cancelRoute()">‚ùå Cancel</button>
                <button onclick="previewRoute()">üëÅÔ∏è Preview</button>
            </div>

            <div id="save-status" class="status" style="display:none;"></div>
        </div>

        <!-- Quick Actions -->
        <div class="section">
            <h3>Quick Actions</h3>
            <button onclick="addNewRoute()">‚ûï Add New Route</button>
            <button onclick="viewCallHistory()">üìä View Call History</button>
            <button onclick="testInbound()">üß™ Test Inbound Call</button>
            <button onclick="exportConfig()">üíæ Export Configuration</button>
            <button onclick="window.location.href='dashboard.html'">‚Üê Back to Admin</button>
        </div>

        <!-- Call History -->
        <div class="section">
            <h3>Recent Inbound Calls</h3>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>From Number</th>
                        <th>Trunk</th>
                        <th>Routed To</th>
                        <th>Duration</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="call-history">
                    <tr>
                        <td colspan="6" class="info">No call history available yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentTrunk = null;
        let selectedRouteType = null;

        function editRoute(trunk) {
            currentTrunk = trunk;
            document.getElementById('route-config').style.display = 'block';
            document.getElementById('route-config').scrollIntoView({ behavior: 'smooth' });

            // Load current configuration
            loadCurrentRoute(trunk);
        }

        function loadCurrentRoute(trunk) {
            // TODO: Load from API
            // For now, default to IVR
            selectRouteType('ivr');
        }

        function selectRouteType(type) {
            selectedRouteType = type;

            // Clear all selections
            document.querySelectorAll('.route-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelectorAll('.config-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Select current
            event.target.closest('.route-option').classList.add('selected');
            document.getElementById('config-' + type).classList.add('active');
        }

        async function saveRoute() {
            const status = document.getElementById('save-status');
            status.style.display = 'block';
            status.className = 'status info';
            status.innerHTML = 'üíæ Saving route configuration...';

            const config = {
                trunk: currentTrunk,
                type: selectedRouteType,
                settings: getRouteSettings()
            };

            try {
                const response = await fetch('/api/inbound-routing.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save',
                        config: config
                    })
                });

                const result = await response.json();

                if (result.success) {
                    status.className = 'status success';
                    status.innerHTML = '‚úÖ Route saved successfully!';

                    // Update display
                    updateRouteDisplay(currentTrunk, config);

                    setTimeout(() => {
                        cancelRoute();
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Save failed');
                }
            } catch (error) {
                status.className = 'status error';
                status.innerHTML = '‚ùå Error: ' + error.message;
            }
        }

        function getRouteSettings() {
            const settings = {};

            switch(selectedRouteType) {
                case 'ivr':
                    settings.menu = document.getElementById('ivr-select').value;
                    settings.greeting = document.getElementById('ivr-greeting').value;
                    break;
                case 'queue':
                    settings.queue = document.getElementById('queue-select').value;
                    settings.moh = document.getElementById('queue-moh').value;
                    settings.announce = document.getElementById('queue-announce').checked;
                    break;
                case 'extension':
                    settings.extension = document.getElementById('ext-select').value;
                    settings.failover = document.getElementById('ext-failover').value;
                    settings.ringtime = document.getElementById('ext-ringtime').value;
                    break;
                case 'voicemail':
                    settings.mailbox = document.getElementById('vm-box').value;
                    settings.email = document.getElementById('vm-email').checked;
                    settings.email_addr = document.getElementById('vm-email-addr').value;
                    break;
                case 'announcement':
                    settings.file = document.getElementById('announce-file').value;
                    settings.action = document.getElementById('announce-action').value;
                    break;
                case 'custom':
                    settings.timeMode = document.getElementById('custom-time').value;
                    settings.businessHours = document.getElementById('custom-bh').value;
                    settings.afterHours = document.getElementById('custom-ah').value;
                    break;
            }

            return settings;
        }

        function updateRouteDisplay(trunk, config) {
            const destElement = document.getElementById(trunk === 'callcentric' ? 'current-dest' : 'gv-dest');
            let destText = '';

            switch(config.type) {
                case 'ivr':
                    destText = `IVR (Extension ${config.settings.menu})`;
                    break;
                case 'queue':
                    destText = `Queue: ${config.settings.queue}`;
                    break;
                case 'extension':
                    destText = `Extension ${config.settings.extension}`;
                    break;
                case 'voicemail':
                    destText = `Voicemail: ${config.settings.mailbox}`;
                    break;
                case 'announcement':
                    destText = `Announcement: ${config.settings.file}`;
                    break;
                case 'custom':
                    destText = `Custom Route (Time-Based)`;
                    break;
            }

            destElement.textContent = destText;
        }

        function cancelRoute() {
            document.getElementById('route-config').style.display = 'none';
            currentTrunk = null;
            selectedRouteType = null;
        }

        function previewRoute() {
            const settings = getRouteSettings();
            alert('Route Preview:\n\n' +
                'Trunk: ' + currentTrunk + '\n' +
                'Type: ' + selectedRouteType + '\n' +
                'Settings: ' + JSON.stringify(settings, null, 2));
        }

        function testRoute(trunk) {
            alert('Testing route for ' + trunk + '...\n\nThis will simulate an inbound call and show the routing path.');
        }

        function addNewRoute() {
            alert('Add new route functionality coming soon!');
        }

        function viewCallHistory() {
            alert('Loading detailed call history...');
        }

        function testInbound() {
            alert('Inbound call test:\n\n1. Call your Callcentric DID from outside\n2. Verify it routes to configured destination\n3. Check call quality and routing');
        }

        function exportConfig() {
            alert('Exporting inbound routing configuration...');
        }
    </script>
</body>
</html>
