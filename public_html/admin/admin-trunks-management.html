<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexPBX Admin - Trunk Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }
        .sidebar a:hover, .sidebar .active {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .trunk-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .trunk-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }
        .status-online {
            color: #28a745;
            animation: pulse 2s infinite;
        }
        .status-offline {
            color: #dc3545;
        }
        .status-warning {
            color: #ffc107;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-result {
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        .test-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .test-error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-none d-md-block sidebar p-3">
                <div class="sidebar-sticky">
                    <div class="text-center mb-4">
                        <h4 class="text-white">FlexPBX Admin</h4>
                        <small class="text-light opacity-75">Trunk Management</small>
                    </div>

                    <ul class="nav flex-column">
                        <li class="nav-item mb-2">
                            <a class="nav-link p-3" href="dashboard.html">
                                <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link p-3 active" href="admin-trunks-management.html">
                                <i class="fas fa-network-wired me-2"></i> Trunk Management
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link p-3" href="admin-extensions-management.html">
                                <i class="fas fa-phone me-2"></i> Extensions
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link p-3" href="admin-google-voice.html">
                                <i class="fab fa-google me-2"></i> Google Voice
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link p-3" href="admin-queues.html">
                                <i class="fas fa-users me-2"></i> Call Queues
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link p-3" href="admin-ivr.html">
                                <i class="fas fa-sitemap me-2"></i> IVR System
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link p-3" href="admin-call-logs.html">
                                <i class="fas fa-history me-2"></i> Call Logs
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-10 ml-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-network-wired me-2 text-primary"></i>
                        SIP Trunk Management
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button class="btn btn-success" onclick="addNewTrunk()">
                            <i class="fas fa-plus me-1"></i> Add New Trunk
                        </button>
                        <button class="btn btn-outline-primary ms-2" onclick="testAllTrunks()">
                            <i class="fas fa-stethoscope me-1"></i> Test All
                        </button>
                    </div>
                </div>

                <!-- Trunk Status Overview -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h3 class="text-success" id="onlineTrunks">2</h3>
                                <p class="mb-0">Online Trunks</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h3 class="text-danger" id="offlineTrunks">0</h3>
                                <p class="mb-0">Offline Trunks</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h3 class="text-info" id="totalCalls">847</h3>
                                <p class="mb-0">Total Calls Today</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h3 class="text-warning" id="activeCalls">3</h3>
                                <p class="mb-0">Active Calls</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trunk Cards -->
                <div class="row">
                    <!-- Callcentric Trunk -->
                    <div class="col-md-6 mb-4">
                        <div class="card trunk-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-circle status-online me-2"></i>
                                    Callcentric Primary
                                </h5>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editTrunk('callcentric')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="testTrunk('callcentric')">
                                        <i class="fas fa-stethoscope"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteTrunk('callcentric')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Provider:</strong> Callcentric<br>
                                        <strong>Server:</strong> sip.callcentric.com<br>
                                        <strong>Port:</strong> 5060
                                    </div>
                                    <div class="col-6">
                                        <strong>Username:</strong> [YOUR_DID]102<br>
                                        <strong>Status:</strong> <span class="badge bg-success">Registered</span><br>
                                        <strong>Calls Today:</strong> 523
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 95%">
                                            95% Quality Score
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Backup Trunk -->
                    <div class="col-md-6 mb-4">
                        <div class="card trunk-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-circle status-online me-2"></i>
                                    Callcentric Backup
                                </h5>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editTrunk('backup')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="testTrunk('backup')">
                                        <i class="fas fa-stethoscope"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteTrunk('backup')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Provider:</strong> Callcentric<br>
                                        <strong>Server:</strong> sip2.callcentric.com<br>
                                        <strong>Port:</strong> 5060
                                    </div>
                                    <div class="col-6">
                                        <strong>Username:</strong> [YOUR_DID]103<br>
                                        <strong>Status:</strong> <span class="badge bg-success">Standby</span><br>
                                        <strong>Calls Today:</strong> 324
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="progress">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 88%">
                                            88% Quality Score
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add/Edit Trunk Modal -->
                <div class="modal fade" id="trunkModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-network-wired me-2"></i>
                                    <span id="modalTitle">Add New Trunk</span>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="trunkForm">
                                    <!-- Basic Information -->
                                    <div class="form-section">
                                        <h6><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Trunk Name *</label>
                                                <input type="text" class="form-control" id="trunkName" placeholder="e.g., Callcentric Primary" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Provider</label>
                                                <select class="form-select" id="provider">
                                                    <option value="callcentric">Callcentric</option>
                                                    <option value="vonage">Vonage</option>
                                                    <option value="twilio">Twilio</option>
                                                    <option value="bandwidth">Bandwidth</option>
                                                    <option value="custom">Custom Provider</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- SIP Registration -->
                                    <div class="form-section">
                                        <h6><i class="fas fa-server me-2"></i>SIP Registration</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">SIP Server/Proxy *</label>
                                                <input type="text" class="form-control" id="sipServer" placeholder="sip.callcentric.com" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Port *</label>
                                                <input type="number" class="form-control" id="sipPort" value="5060" min="1024" max="65535" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Transport</label>
                                                <select class="form-select" id="transport">
                                                    <option value="udp">UDP</option>
                                                    <option value="tcp">TCP</option>
                                                    <option value="tls">TLS</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Username/Account ID *</label>
                                                <input type="text" class="form-control" id="username" placeholder="Your DID or Account ID" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Password *</label>
                                                <div class="input-group">
                                                    <input type="password" class="form-control" id="password" placeholder="SIP Password" required>
                                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Auth Name</label>
                                                <input type="text" class="form-control" id="authName" placeholder="Leave blank to use username">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">From Domain</label>
                                                <input type="text" class="form-control" id="fromDomain" placeholder="Optional: custom from domain">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Audio Settings -->
                                    <div class="form-section">
                                        <h6><i class="fas fa-volume-up me-2"></i>Audio & Codec Settings</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Preferred Codecs</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="codec_g722" checked>
                                                    <label class="form-check-label" for="codec_g722">G.722 (HD Audio)</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="codec_ulaw" checked>
                                                    <label class="form-check-label" for="codec_ulaw">G.711u (PCMU)</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="codec_alaw">
                                                    <label class="form-check-label" for="codec_alaw">G.711a (PCMA)</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="codec_g729">
                                                    <label class="form-check-label" for="codec_g729">G.729 (Low Bandwidth)</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">DTMF Method</label>
                                                <select class="form-select" id="dtmfMethod">
                                                    <option value="rfc2833">RFC2833 (Recommended)</option>
                                                    <option value="info">SIP INFO</option>
                                                    <option value="inband">In-band</option>
                                                </select>

                                                <label class="form-label mt-3">RTP Timeout (seconds)</label>
                                                <input type="number" class="form-control" id="rtpTimeout" value="60" min="30" max="300">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Dial Patterns -->
                                    <div class="form-section">
                                        <h6><i class="fas fa-phone-square-alt me-2"></i>Dial Patterns & Routing</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Outbound Dial Pattern</label>
                                                <input type="text" class="form-control" id="dialPattern" value="9|NXXNXXXXXX" placeholder="9|NXXNXXXXXX">
                                                <small class="form-text text-muted">Pattern for outbound calls (9 + 10-digit number)</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">International Pattern</label>
                                                <input type="text" class="form-control" id="intlPattern" value="9011|.+" placeholder="9011|.+">
                                                <small class="form-text text-muted">Pattern for international calls</small>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-12">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="emergencyCalls" checked>
                                                    <label class="form-check-label" for="emergencyCalls">
                                                        Allow Emergency Calls (911)
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="internationalCalls">
                                                    <label class="form-check-label" for="internationalCalls">
                                                        Allow International Calls
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tollFreeCalls" checked>
                                                    <label class="form-check-label" for="tollFreeCalls">
                                                        Allow Toll-Free Calls (1-800, etc.)
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Test Results Area -->
                                    <div id="testResults" style="display: none;"></div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-warning" onclick="testTrunkConfig()">
                                    <i class="fas fa-stethoscope me-1"></i> Test Configuration
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveTrunk()">
                                    <i class="fas fa-save me-1"></i> Save Trunk
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Real-time Logs -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-list me-2"></i>Real-time Trunk Activity</h5>
                            </div>
                            <div class="card-body">
                                <div id="trunkLogs" style="height: 200px; overflow-y: scroll; background: #f8f9fa; padding: 15px; font-family: monospace;">
                                    <div class="text-success">[2025-10-13 14:23:15] Callcentric Primary: Registration successful</div>
                                    <div class="text-info">[2025-10-13 14:23:12] Outbound call to +1234567890 via Callcentric Primary</div>
                                    <div class="text-success">[2025-10-13 14:23:10] Callcentric Backup: Registration successful</div>
                                    <div class="text-warning">[2025-10-13 14:22:58] High latency detected on Callcentric Primary (87ms)</div>
                                    <div class="text-info">[2025-10-13 14:22:45] Incoming call from +1987654321 routed to extension 2001</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="flexpbx-dynamic-ui.js"></script>
    <script>
        // Trunk management functions
        function addNewTrunk() {
            document.getElementById('modalTitle').textContent = 'Add New Trunk';
            document.getElementById('trunkForm').reset();
            new bootstrap.Modal(document.getElementById('trunkModal')).show();
        }

        function editTrunk(trunkId) {
            document.getElementById('modalTitle').textContent = 'Edit Trunk Configuration';

            // Load trunk configuration based on ID
            if (trunkId === 'callcentric') {
                document.getElementById('trunkName').value = 'Callcentric Primary';
                document.getElementById('provider').value = 'callcentric';
                document.getElementById('sipServer').value = 'sip.callcentric.com';
                document.getElementById('sipPort').value = '5060';
                document.getElementById('username').value = '[YOUR_DID]102';
                document.getElementById('password').value = '[YOUR_PASSWORD]';
            }

            new bootstrap.Modal(document.getElementById('trunkModal')).show();
        }

        function deleteTrunk(trunkId) {
            if (confirm('Are you sure you want to delete this trunk? This action cannot be undone.')) {
                // Send delete request to API
                fetch('/api/trunks/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trunk_id: trunkId })
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          location.reload();
                      } else {
                          alert('Error deleting trunk: ' + data.error);
                      }
                  });
            }
        }

        function testTrunk(trunkId) {
            const logDiv = document.getElementById('trunkLogs');
            logDiv.innerHTML += `<div class="text-info">[${new Date().toLocaleString()}] Testing ${trunkId} trunk...</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;

            // Send test request to API
            fetch('/api/trunks/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ trunk_id: trunkId })
            }).then(response => response.json())
              .then(data => {
                  const status = data.success ? 'text-success' : 'text-danger';
                  const message = data.success ? 'Test passed successfully' : `Test failed: ${data.error}`;
                  logDiv.innerHTML += `<div class="${status}">[${new Date().toLocaleString()}] ${trunkId}: ${message}</div>`;
                  logDiv.scrollTop = logDiv.scrollHeight;
              });
        }

        function testAllTrunks() {
            testTrunk('callcentric');
            setTimeout(() => testTrunk('backup'), 2000);
        }

        function testTrunkConfig() {
            const formData = new FormData(document.getElementById('trunkForm'));
            const config = Object.fromEntries(formData.entries());

            const resultsDiv = document.getElementById('testResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="test-result test-success">Testing configuration...</div>';

            // Send test request
            fetch('/api/trunks/test-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            }).then(response => response.json())
              .then(data => {
                  const resultClass = data.success ? 'test-success' : 'test-error';
                  const icon = data.success ? 'check-circle' : 'exclamation-triangle';
                  resultsDiv.innerHTML = `
                      <div class="test-result ${resultClass}">
                          <i class="fas fa-${icon} me-2"></i>
                          <strong>${data.success ? 'Configuration Test Passed' : 'Configuration Test Failed'}</strong>
                          <br>${data.message}
                          ${data.details ? '<br><small>' + data.details + '</small>' : ''}
                      </div>
                  `;
              });
        }

        function saveTrunk() {
            const formData = new FormData(document.getElementById('trunkForm'));
            const config = Object.fromEntries(formData.entries());

            // Collect codec preferences
            config.codecs = [];
            if (document.getElementById('codec_g722').checked) config.codecs.push('g722');
            if (document.getElementById('codec_ulaw').checked) config.codecs.push('ulaw');
            if (document.getElementById('codec_alaw').checked) config.codecs.push('alaw');
            if (document.getElementById('codec_g729').checked) config.codecs.push('g729');

            fetch('/api/trunks/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      bootstrap.Modal.getInstance(document.getElementById('trunkModal')).hide();
                      location.reload();
                  } else {
                      alert('Error saving trunk: ' + data.error);
                  }
              });
        }

        function togglePassword() {
            const passwordField = document.getElementById('password');
            const toggleIcon = event.target.closest('button').querySelector('i');

            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordField.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        // Auto-populate provider settings
        document.getElementById('provider').addEventListener('change', function() {
            const provider = this.value;
            const serverField = document.getElementById('sipServer');
            const portField = document.getElementById('sipPort');

            switch(provider) {
                case 'callcentric':
                    serverField.value = 'sip.callcentric.com';
                    portField.value = '5060';
                    break;
                case 'vonage':
                    serverField.value = 'sip.vonage.com';
                    portField.value = '5060';
                    break;
                case 'twilio':
                    serverField.value = 'trunk.twilio.com';
                    portField.value = '5060';
                    break;
                case 'bandwidth':
                    serverField.value = 'trunk.bandwidth.com';
                    portField.value = '5060';
                    break;
            }
        });

        // Update real-time logs every 5 seconds
        setInterval(function() {
            fetch('/api/trunks/logs')
                .then(response => response.json())
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        const logDiv = document.getElementById('trunkLogs');
                        data.logs.forEach(log => {
                            const statusClass = log.level === 'success' ? 'text-success' :
                                              log.level === 'error' ? 'text-danger' :
                                              log.level === 'warning' ? 'text-warning' : 'text-info';
                            logDiv.innerHTML += `<div class="${statusClass}">[${log.timestamp}] ${log.message}</div>`;
                        });
                        logDiv.scrollTop = logDiv.scrollHeight;
                    }
                });
        }, 5000);
    </script>
</body>
</html>